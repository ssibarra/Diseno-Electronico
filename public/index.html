<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>Taxi Tracker</title>
		<link rel="stylesheet" type="text/css" href="css/estilos.css">
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" />
	    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"></script>
	    <style>
	    	#map {position: absolute; top: 0; right: 0; bottom: 0; left: 1; height: 100%; width: 85%;}
	    </style>
	    
	</head>
	<body id="contenido">
			<header>
				<div id="imgpro">
					<img src="images/LogoTaxi.jpg">
				</div>
			</header>
			<section id="map">
							<script>
							    var map = L.map('map').setView([10.96479, -74.79355], 12);
							    L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=HN1Y37NyX68vLnrA36fj',{
							      tileSize: 512,
							      zoomOffset: -1,
							      minZoom: 1,
							      attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap contributors</a>',
							      crossOrigin: true
							    }).addTo(map);
			  				</script>
			</section>
			<div class="wrap">
				<ul class="tabs">
					<li><a href="#tab1"><span class="tab-text">Posición Actual</span></a></li>
					<li><a href="#tab2"><span class="tab-text">Registro</span></a></li>
				</ul>
				<div class="secciones">
					<article id="tab1">
						<aside id="Actual">
							<br/>
							<br/>
							<br/>
							<h1>GPS Syrus</h1>
							<br/>
							<p id="calendar"></p>
							<br/>
							<p id="clock"></p>
							<br/>
							<p id="lati"></p>
							<br/>
							<p id="long"></p>
						</aside>
					</article>
					<article id="tab2">
			  			<aside id="HistorialFechaHora">
							<label>Fecha y Hora de Inicio</label>
							<input type="datetime-local" name="comienzo" id="comienzo" value="2019-09-25T13:00" >
							<label>Fecha y Hora de Fin</label>
							<input type="datetime-local" name="final" id="final" value="2019-09-25T15:00" >
							<button onclick="getDateTime();">Enviar</button>
						</aside>
						<aside id="tie">
							<h3>Consulta de resgistros</h3>
						</aside>
					</article>
				</div>
	  		</div>
	</body>
</html>
<script type="text/javascript">
var activeTab
var poly = L.polyline([]);
var layerGroup = L.featureGroup().addTo(map);
	$(document).ready(function(){
		$('ul.tabs li a:first').addClass('active');
		$('.secciones article').hide(); /* Ocultamos a todos */
		$('.secciones article:first').show();
		inicio();		
    	$('ul.tabs li a').click(function tabsclick(){          /* Cuando le undamos click a un enlace se va a ejecutar una funcion */
			$('ul.tabs li a').removeClass('active');
			$(this).addClass('active');
			$('.secciones article').hide();          /* Cuando hagamos clik todas las secciones se ocultan */
			activeTab = $(this).attr('href');  /* Cuando le undamos click va a traer el atributo del href que sea */
			prepare(activeTab);
			$(activeTab).show();
		});
	});
	function inicio(){
		activeTab = '#tab1'
		realtime();

	};
	function prepare(activeTab){
		if (activeTab == '#tab1') {
			realtime(activeTab);

		}else{
			erase(layerGroup,poly);
		};
	}
	
	//var poliGroup = L.layerGroup().addTo(map);
	function realtime() {
		if (activeTab=='#tab1') {
	        fetch("/realtime")
	        .then(function(res) { 
	          return res.json();
	        })
	        .then(data => {
	          lat = data[0].latitude;
	          lon = data[0].longitude;
	          date = data[0].date;
	          const year = date[0].concat(date[1],date[2],date[3]);
	          const month = date[4].concat(date[5]);
	          const day = date[6].concat(date[7]);
	          const hour = date[8].concat(date[9]);
	          const min = date[10].concat(date[11]);
	          const sec = date[12].concat(date[13]);
	          document.getElementById("calendar").innerHTML = "<b>Day:</b><br>".concat(day.concat("/",month,"/",year));
	          document.getElementById("clock").innerHTML    = "<b>Hour:</b><br>".concat(hour.concat(":",min,":",sec));
	          document.getElementById("lati").innerHTML     = "<b>Latitude:</b> <br>".concat(lat);
	          document.getElementById("long").innerHTML     = "<b>Longitude:</b> <br>".concat(lon);
	          var punto = L.marker([lat, lon]).addTo(map);
	          punto.bindPopup("<b>Hello I'm in !</b><br> ["+ lat + "," + lon + "]<br> Date: " + year + "/" + month +"/" + day+ "<br> Hour: "+ hour + ":" + min + ":" + sec).openPopup();
	          punto.addTo(layerGroup);
	          polyline(lat, lon);
	          //poly.addTo(map);
	          poly.addTo(layerGroup);

	          setTimeout(realtime, 2000);
	        });
    };
}

	        function polyline(lat,lon){
	          var newpoly = new L.LatLng(lat,lon);
	          poly.addLatLng(newpoly);
	          //poly.addTo(poliGroup)
	          
	        }
//Obtener la info del formulario
		function getDateTime() {
		// Obtener formulario de inicio y final
  		var dtlinicio = document.getElementById("comienzo").value;
  		var dtlfinal = document.getElementById("final").value;
  		if ((dtlinicio == '') || (dtlfinal == '') || (dtlinicio == dtlfinal) || (dtlfinal < dtlinicio)) {
			alert('Dear user, please type the form correctly');
		} else {
			// Fragmentación de datos
			var initialdate = dtlinicio[0].concat(dtlinicio[1],dtlinicio[2],dtlinicio[3],dtlinicio[5],dtlinicio[6],dtlinicio[8],dtlinicio[9],dtlinicio[11],dtlinicio[12],dtlinicio[14],dtlinicio[15],"00"); 
			var finaldate = dtlfinal[0].concat(dtlfinal[1],dtlfinal[2],dtlfinal[3],dtlfinal[5],dtlfinal[6],dtlfinal[8],dtlfinal[9],dtlfinal[11],dtlfinal[12],dtlfinal[14],dtlfinal[15],"00");
			console.log(initialdate);
			console.log(finaldate);
			historical(initialdate,finaldate);
			};
		};	
//Historicos
	function historical(initiald, finald) {
        const miralo = {initialdate: initiald, finaldate: finald};
        const options = {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(miralo)
        };
        fetch("/historical", options)
        .then(function(res) {
          return res.json();
        })
        .then(data => {
          console.log(data);
          console.log(data.length);
          console.log(data[2].date);
        });
    }
/*
	function prueba(){
		var marker = L.marker([11.010, -74.85]).addTo(map);
		marker.bindPopup("<b>Marker 1 !</b>").openPopup();
		marker.addTo(layerGroup);
		//erase(layerGroup);
	}*/

//Borrar data
	function erase(layerGroup,poly){
		layerGroup.clearLayers();
		//poly.setLatlngs([]);

		//poliGroup.removeLayer();
		/*var marker = L.marker([11.013456, -74.856488]).addTo(map);
		marker.bindPopup("<b>Marker erase !</b>").openPopup();*/
	}
</script>

