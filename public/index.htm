<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Taxi Ubication</title>
    <style>
      #map {
        height: 400px;
        width: 48%;
        float: right;
        margin: 1%;
      }
      .GPS-Box {
        height: 400px;
        width: 48%;
        float: left;
        margin: 1%;
      }
    </style>
  </head>

  <body>
    <h1>TAXI UBICATION</h1>
    <div class="GPS-Box">
      <div>
        Latitude:
        <div id="Lat" class="Coordinates" style="float: right"></div>
      </div>
      <div>
        Longitude:

        <div id="Long" class="Coordinates" style="float: right"></div>
      </div>
      <div>
        Date:

        <div id="Date" class="Coordinates" style="float: right"></div>
      </div>
      Time:

      <div id="Time" class="Coordinates" style="float: right"></div>
    </div>
    <div id="map"></div>

    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPLLzHwARFL3Nbw21l2kv6-Uz0yyy95Kk&callback=initMap"
    ></script>
  </body>
</html>

<script>
  let longi = document.getElementById("Long");
  let lati = document.getElementById("Lat");
  let date = document.getElementById("Date");
  let time = document.getElementById("Time");
  let lat = 0;
  let lng = 0;
  let map, marker;

  function act(long, lat, dat, tim) {
    longi.innerText = ` ${long}`;
    lati.innerText = ` ${lat}`;
    date.innerText = ` ${dat}`;
    time.innerText = ` ${tim}`;
  }

  function fetchData() {
    fetch("/query")
      .then(function(res) {
        return res.json();
      })
      .then(data => {
        var data = data;
        lat = data.lat;
        lng = data.lon;
        now = new Date();
        // let nWeeks, day, time, lon, lat;
        act(`${data.lon}`, `${data.lat}`, `${data.date}`, `${data.time}`);
      });
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 17,
      center: { lat: 0, lng: 0 }
    });
    marker = new google.maps.Marker({ position: { lat: 0, lng: 0 }, map: map });

    function addMarker(newCoord) {
      marker.setMap(null);
      marker.position = 0;
      marker = new google.maps.Marker({
        position: newCoord,
        map
      });
      marker.setMap(map);
      map.setCenter(marker.getPosition());
    }
    function actMap() {
      addMarker({ lat: parseFloat(lat), lng: parseFloat(lng) });
      setTimeout(actMap, 3000);
    }
    actMap();
  }

  function go() {
    fetchData();
    setTimeout(go, 3000); // callback
  }
  go();
</script>
